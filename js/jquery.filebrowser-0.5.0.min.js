/**@license
 *
 * jQuery File Browser - directory browser jQuery plugin version 0.5.0
 *
 * Copyright (c) 2016 Jakub Jankiewicz <http://jcubic.pl>
 * Released under the MIT license
 *
 * Date: Sat, 17 Dec 2016 13:04:52 +0000
 */
(function(e,r){e.browse={defaults:{dir:function(){return{files:[],dirs:[]}},root:"/",separator:"/",labels:true,change:e.noop,init:e.noop,item_class:e.noop,open:e.noop,rename:e.noop,copy:e.noop,name:"default",error:e.noop,refresh_timer:100},strings:{toolbar:{back:"back",up:"up",refresh:"refresh"}},escape_regex:function(e){if(typeof e=="string"){var r=/([-\\\^$\[\]()+{}?*.|])/g;return e.replace(r,"\\$1")}}};var t;var n;var s={};var a;function o(e){return function(r){return e==r}}e.fn.browse=function(r){var i=e.extend({},e.browse.defaults,r);if(this.data("browse")){return this.data("browse")}else if(this.length>1){return this.each(function(){e.fn.browse.call(e(this),i)})}else{var l="browser-widget";s[i.name]=s[i.name]||[];var c=this;c.addClass(l+" hidden");var f;var d=[];var h;var u=e('<ul class="toolbar"></ul>').appendTo(c);if(i.labels){u.addClass("labels")}var p=e('<div class="adress-bar"></div>').appendTo(u);e("<button>Home</button>").addClass("home").appendTo(p);var v=e("<input />").appendTo(p);var m=e.browse.strings.toolbar;Object.keys(m).forEach(function(r){e("<li/>").text(m[r]).addClass(r).appendTo(u)});var w=e("<ul/>").addClass("content").appendTo(c);u.on("click.browse","li",function(){var r=e(this);if(!r.hasClass("disabled")){var t=r.text();c[t]()}}).on("click",".home",function(){if(f!=i.root){c.show(i.root)}}).on("keypress.browse","input",function(r){if(r.which==13){var t=e(this);var n=t.val();c.show(n)}});w.on("dblclick.browse","li",function(){var r=e(this);var t=c.join(f,r.text());if(r.hasClass("directory")){r.removeClass("selected");c.show(t)}else if(r.hasClass("file")){i.open(t)}}).on("click.browse","li",function(r){var t=e(this);if(!r.ctrlKey){t.siblings().removeClass("selected")}t.toggleClass("selected");var n=c.join(f,t.text());if(t.hasClass("selected")){if(!r.ctrlKey){s[i.name]=[]}s[i.name].push(n)}else if(r.ctrlKey){s[i.name]=s[i.name].filter(o(n))}else{s[i.name]=[]}});c.on("click.browse",function(r){e("."+l).removeClass("selected");e(this).addClass("selected");var t=e(r.target);if(!r.ctrlKey&&!t.is(".content li")&&!t.closest(".toolbar").length){w.find("li").removeClass("selected");s[i.name]=[]}});c.on("dragover",".content",function(){return false}).on("dragstart",".content li",function(){var r=e(this);var t=r.text();a={name:t,path:f,context:c};if(r.hasClass("selected")){a.selection=true}});function b(r,t){return r===t||t.match(new RegExp("^"+e.browse.escape_regex(r)))}w.on("drop",function(r){var t=e(r.target);var n;if(t.is(".directory")){n=c.join(f,t.text(),a.name)}else{n=c.join(f,a.name)}if(c.name()!==a.context.name()){throw new Error("You can't drag across different filesystems")}if(a.selection){s[i.name].forEach(function(e){if(!b(e,n)){c._rename(e,n)}});c.refresh();if(c!==a.context){a.context.refresh()}}else{var o=c.join(a.path,a.name);if(!b(o,n)){c._rename(o,n);c.refresh();if(c!==a.context){a.context.refresh()}}}return false});function g(e){if(c.hasClass("selected")){if(e.ctrlKey){if(e.which==67){c.copy()}else if(e.which==88){c.cut()}else if(e.which==86){c.paste(n)}}else if(e.which==8){c.back()}else{var r=w.find(".selected");if(e.which==13&&r.length){r.dblclick()}else{if(e.which>=37&&e.which<=40){var t;var a=w.find("li");if(!r.length){r=w.find("li:eq(0)");t=0}else{r.removeClass("selected");var o=w.prop("clientWidth");var l=a.length;var d=w.find("li:eq(0)").outerWidth(true);var h=Math.floor(o/d);t=r.index();if(e.which==37){t--}else if(e.which==38){t=t-h}else if(e.which==39){t++}else if(e.which==40){t=t+h}if(t<0){t=0}else if(t>l-1){t=l-1}}if(e.which>=37&&e.which<=40){var u=a.eq(t).addClass("selected");var p=c.join(f,u.text());if(u.length){s[i.name]=[p]}else{s[i.name]=[]}}}}}}}function C(r){if(!e(r.target).closest("."+l).length){e(".browser-widget").removeClass("selected")}}e(document).on("click",C).on("keydown",g);e.extend(c,{path:function(){return f},name:function(){return i.name},current:function(){return current},back:function(){d.pop();c.show(d[d.length-1],{push:false});return c},destroy:function(){c.off(".browse");e(document).off("click",C).off("keydown",g);p.remove();w.remove()},_rename:function(e,r){if(!b(e,r)){i.rename(e,r)}},_copy:function(e,r){i.copy(e,r)},copy:function(){t={path:f,contents:s[i.name],source:c};n=false},cut:function(){c.copy();n=true},paste:function(e){function r(e,r){t.contents.forEach(function(t){var n=e.split(t).pop();var s=e.join(f,n);if(!b(t,s)){e[r](t,s)}})}if(t&&t.contents&&t.contents.length){if(c.name()!==t.source.name()){throw new Error("You can't paste across different filesystems")}else{if(e){r(c,"_rename")}else{r(c,"_copy")}c.refresh();if(c!==t.source){t.source.refresh()}}}},up:function(){var e=c.split(f);e.pop();c.show(c.join.apply(c,e));return c},refresh:function(){w.addClass("hidden");var r=e.Deferred();var t=e.Deferred();if(i.refresh_timer){setTimeout(r.resolve.bind(r),i.refresh_timer)}else{r.resolve()}c.show(f,{force:true,push:false,callback:function(){t.resolve()}});e.when(r,t).then(function(){w.removeClass("hidden")})},show:function(r,t){var n={callback:e.noop,push:true,force:false};t=e.extend({},n,t);if(f!=r||t.force){c.addClass("hidden");if(t.push){d.push(r)}u.find(".up").toggleClass("disabled",r==i.root);u.find(".back").toggleClass("disabled",d.length==1);f=r;i.dir(f,function(n){if(!n){i.error("Invalid directory");c.removeClass("hidden")}else{h=n;c.addClass("hidden");w.empty();h.dirs.forEach(function(t){var n=i.item_class(r,t);var s=e('<li class="directory">'+t+"</li>").appendTo(w).attr("draggable",true);if(n){s.addClass(n)}});h.files.forEach(function(t){var n=e('<li class="file">'+t+"</li>").appendTo(w).attr("draggable",true);if(t.match(".")){n.addClass(t.split(".").pop())}var s=i.item_class(r,t);if(s){n.addClass(s)}});c.removeClass("hidden");v.val(r);i.change.call(c);t.callback()}})}return c},join:function(){var r=[].slice.call(arguments);var t=r.map(function(r){var t=new RegExp(e.browse.escape_regex(i.separator)+"$","");return r.replace(t,"")}).filter(Boolean).join(i.separator);var n=new RegExp("^"+e.browse.escape_regex(i.root));return n.test(t)?t:i.root+t},split:function(r){var t=new RegExp("^"+e.browse.escape_regex(i.root));var n=new RegExp(e.browse.escape_regex(i.separator)+"$");r=r.replace(t,"").replace(n,"");if(r){return r.split(i.separator)}else{return[]}},walk:function(e,r){var t=this.split(e);var n;while(t.length){n=r(t.shift(),!t.length)}return n}});setTimeout(function(){var e=i.start_directory||i.root;c.show(e,{callback:i.init.bind(c)})},0);c.data("browse",c);return c}}})(jQuery);