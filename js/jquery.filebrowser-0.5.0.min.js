/**@license
 *
 * jQuery File Browser - directory browser jQuery plugin version 0.5.0
 *
 * Copyright (c) 2016 Jakub Jankiewicz <http://jcubic.pl>
 * Released under the MIT license
 *
 * Date: Sat, 17 Dec 2016 15:20:26 +0000
 */
(function(e,t){e.browse={defaults:{dir:function(){return{files:[],dirs:[]}},root:"/",separator:"/",labels:true,change:e.noop,init:e.noop,item_class:e.noop,open:e.noop,rename:e.noop,copy:e.noop,name:"default",error:e.noop,refresh_timer:100},strings:{toolbar:{back:"back",up:"up",refresh:"refresh"}},escape_regex:function(e){if(typeof e=="string"){var t=/([-\\\^$\[\]()+{}?*.|])/g;return e.replace(t,"\\$1")}}};var r;var a;var n={};var s;function o(e){return function(t){return e==t}}e.fn.browse=function(t){var i=e.extend({},e.browse.defaults,t);if(this.data("browse")){return this.data("browse")}else if(this.length>1){return this.each(function(){e.fn.browse.call(e(this),i)})}else{var l="browser-widget";n[i.name]=n[i.name]||[];var c=this;c.addClass(l+" hidden");var f;var d=[];var h;var u=e('<ul class="toolbar"></ul>').appendTo(c);if(i.labels){u.addClass("labels")}var p=e('<div class="adress-bar"></div>').appendTo(u);e("<button>Home</button>").addClass("home").appendTo(p);var v=e("<input />").appendTo(p);var m=e.browse.strings.toolbar;Object.keys(m).forEach(function(t){e("<li/>").text(m[t]).addClass(t).appendTo(u)});var w=e("<ul/>").wrap("<div/>").parent().addClass("content").appendTo(c);var b=w.find("ul");var g=0,C=0,x=0,y=0;var k=e("<div/>").addClass("selection").hide().appendTo(w);var _=false;var T=false;u.on("click.browse","li",function(){var t=e(this);if(!t.hasClass("disabled")){var r=t.text();c[r]()}}).on("click",".home",function(){if(f!=i.root){c.show(i.root)}}).on("keypress.browse","input",function(t){if(t.which==13){var r=e(this);var a=r.val();c.show(a)}});w.on("dblclick.browse","li",function(){var t=e(this);var r=c.join(f,t.text());if(t.hasClass("directory")){t.removeClass("selected");c.show(r)}else if(t.hasClass("file")){i.open(r)}}).on("click.browse","li",function(t){var r=e(this);if(!t.ctrlKey){r.siblings().removeClass("selected")}r.toggleClass("selected");var a=c.join(f,r.text());if(r.hasClass("selected")){if(!t.ctrlKey){n[i.name]=[]}n[i.name].push(a)}else if(t.ctrlKey){n[i.name]=n[i.name].filter(o(a))}else{n[i.name]=[]}});c.on("click.browse",function(t){if(!T){e("."+l).removeClass("selected");e(this).addClass("selected");var r=e(t.target);if(!t.ctrlKey&&!r.is(".content li")&&!r.closest(".toolbar").length){w.find("li").removeClass("selected");n[i.name]=[]}}});c.on("dragover.browse",".content",function(){return false}).on("dragstart",".content li",function(){var t=e(this);var r=t.text();s={name:r,path:f,context:c};if(t.hasClass("selected")){s.selection=true}});function j(t,r){return t===r||r.match(new RegExp("^"+e.browse.escape_regex(t)))}w.on("drop.browse",function(t){var r=e(t.target);var a;if(r.is(".directory")){a=c.join(f,r.text(),s.name)}else{a=c.join(f,s.name)}if(c.name()!==s.context.name()){throw new Error("You can't drag across different filesystems")}if(s.selection){n[i.name].forEach(function(e){if(!j(e,a)){c._rename(e,a)}});c.refresh();if(c!==s.context){s.context.refresh()}}else{var o=c.join(s.path,s.name);if(!j(o,a)){c._rename(o,a);c.refresh();if(c!==s.context){s.context.refresh()}}}return false}).on("mousedown.browse",function(e){k.show();_=true;T=false;c.addClass("no-select");var t=w.offset();g=e.clientX-t.left;C=e.clientY-t.top;K()});function E(t){var r=w.offset();x=t.clientX-r.left;y=t.clientY-r.top+w.scrollTop();K();if(_){T=true;var a=w.find("li");if(!t.ctrlKey){a.removeClass("selected")}var n=k.offset();var s=k.width();var o=k.height();var i=a.filter(function(){var t=e(this);var r=t.offset();var a=t.height();var i=t.width();return r.left>n.left&&n.left+s>r.left&&r.top>n.top&&n.top+o>r.top||r.left<n.left&&r.left+i>n.left&&r.top+a>n.top&&r.top<n.top+o||r.left<n.left+s&&r.left>n.left&&r.top<n.top+o&&r.top+a>n.top});i.addClass("selected")}}function M(e){_=false;k.hide();c.removeClass("no-select")}function K(e){var t=Math.max(Math.min(g,x),0);var r=Math.max(Math.min(C,y),0);var a=Math.max(g,x);var n=Math.max(C,y);var s=w.prop("clientWidth");var o=w.height()+w.scrollTop()-2;if(a>s){a=s}if(n>o){n=o}k.css({left:t,top:r,width:a-t,height:n-r})}function R(e){if(c.hasClass("selected")){if(e.ctrlKey){if(e.which==67){c.copy()}else if(e.which==88){c.cut()}else if(e.which==86){c.paste(a)}}else if(e.which==8){c.back()}else{var t=w.find(".selected");if(e.which==13&&t.length){t.dblclick()}else{if(e.which>=37&&e.which<=40){var r;var s=w.find("li");if(!t.length){t=w.find("li:eq(0)");r=0}else{t.removeClass("selected");var o=w.prop("clientWidth");var l=s.length;var d=w.find("li:eq(0)").outerWidth(true);var h=Math.floor(o/d);r=t.index();if(e.which==37){r--}else if(e.which==38){r=r-h}else if(e.which==39){r++}else if(e.which==40){r=r+h}if(r<0){r=0}else if(r>l-1){r=l-1}}if(e.which>=37&&e.which<=40){var u=s.eq(r).addClass("selected");var p=c.join(f,u.text());if(u.length){n[i.name]=[p]}else{n[i.name]=[]}}}}}}}function Y(t){if(!e(t.target).closest("."+l).length){e(".browser-widget").removeClass("selected")}}e(document).on("click",Y).on("keydown",R).on("mousemove",E).on("mouseup",M);e.extend(c,{path:function(){return f},name:function(){return i.name},current:function(){return current},back:function(){d.pop();c.show(d[d.length-1],{push:false});return c},destroy:function(){c.off(".browse");e(document).off("click",Y).off("keydown",R);p.remove();w.remove()},_rename:function(e,t){if(!j(e,t)){i.rename(e,t)}},_copy:function(e,t){i.copy(e,t)},copy:function(){r={path:f,contents:n[i.name],source:c};a=false},cut:function(){c.copy();a=true},paste:function(e){function t(e,t){r.contents.forEach(function(r){var a=e.split(r).pop();var n=e.join(f,a);if(!j(r,n)){e[t](r,n)}})}if(r&&r.contents&&r.contents.length){if(c.name()!==r.source.name()){throw new Error("You can't paste across different filesystems")}else{if(e){t(c,"_rename")}else{t(c,"_copy")}c.refresh();if(c!==r.source){r.source.refresh()}}}},up:function(){var e=c.split(f);e.pop();c.show(c.join.apply(c,e));return c},refresh:function(){w.addClass("hidden");var t=e.Deferred();var r=e.Deferred();if(i.refresh_timer){setTimeout(t.resolve.bind(t),i.refresh_timer)}else{t.resolve()}c.show(f,{force:true,push:false,callback:function(){r.resolve()}});e.when(t,r).then(function(){w.removeClass("hidden")})},show:function(t,r){var a={callback:e.noop,push:true,force:false};r=e.extend({},a,r);if(f!=t||r.force){c.addClass("hidden");if(r.push){d.push(t)}u.find(".up").toggleClass("disabled",t==i.root);u.find(".back").toggleClass("disabled",d.length==1);f=t;i.dir(f,function(a){if(!a){i.error("Invalid directory");c.removeClass("hidden")}else{h=a;c.addClass("hidden");b.empty();h.dirs.forEach(function(r){var a=i.item_class(t,r);var n=e('<li class="directory">'+r+"</li>").appendTo(b).attr("draggable",true);if(a){n.addClass(a)}});h.files.forEach(function(r){var a=e('<li class="file">'+r+"</li>").appendTo(b).attr("draggable",true);if(r.match(".")){a.addClass(r.split(".").pop())}var n=i.item_class(t,r);if(n){a.addClass(n)}});c.removeClass("hidden");v.val(t);i.change.call(c);r.callback()}})}return c},join:function(){var t=[].slice.call(arguments);var r=t.map(function(t){var r=new RegExp(e.browse.escape_regex(i.separator)+"$","");return t.replace(r,"")}).filter(Boolean).join(i.separator);var a=new RegExp("^"+e.browse.escape_regex(i.root));return a.test(r)?r:i.root+r},split:function(t){var r=new RegExp("^"+e.browse.escape_regex(i.root));var a=new RegExp(e.browse.escape_regex(i.separator)+"$");t=t.replace(r,"").replace(a,"");if(t){return t.split(i.separator)}else{return[]}},walk:function(e,t){var r=this.split(e);var a;while(r.length){a=t(r.shift(),!r.length)}return a}});setTimeout(function(){var e=i.start_directory||i.root;c.show(e,{callback:i.init.bind(c)})},0);c.data("browse",c);return c}}})(jQuery);