/**@license
 *
 * jQuery File Browser - directory browser jQuery plugin version 0.3.0
 *
 * Copyright (c) 2016 Jakub Jankiewicz <http://jcubic.pl>
 * Released under the MIT license
 *
 * Date: Sun, 11 Dec 2016 17:33:20 +0000
 */
(function(e,r){e.browse={defaults:{dir:function(){return{files:[],dirs:[]}},root:"/",separator:"/",labels:true,change:e.noop,init:e.noop,item_class:e.noop,open:e.noop,rename:e.noop,copy:e.noop,name:"default",error:e.noop,refresh_timer:100},strings:{toolbar:{back:"back",up:"up",refresh:"refresh"}},escape_regex:function(e){if(typeof e=="string"){var r=/([-\\\^$\[\]()+{}?*.|])/g;return e.replace(r,"\\$1")}}};var s;var n;var t={};function a(e){return function(r){return e==r}}e.fn.browse=function(r){var o=e.extend({},e.browse.defaults,r);if(this.data("browse")){return this.data("browse")}else if(this.length>1){return this.each(function(){e.fn.browse.call(e(this),o)})}else{var i="browser-widget";t[o.name]=t[o.name]||[];var l=this;l.addClass(i+" hidden");var c;var f=[];var d;var h=e('<ul class="toolbar"></ul>').appendTo(l);if(o.labels){h.addClass("labels")}var u=e('<div class="adress-bar"></div>').appendTo(h);e("<button>Home</button>").addClass("home").appendTo(u);var p=e("<input />").appendTo(u);var v=e.browse.strings.toolbar;Object.keys(v).forEach(function(r){e("<li/>").text(v[r]).addClass(r).appendTo(h)});var w=e("<ul/>").addClass("content").appendTo(l);h.on("click.browse","li",function(){var r=e(this);if(!r.hasClass("disabled")){var s=r.text();l[s]()}}).on("click",".home",function(){if(c!=o.root){l.show(o.root)}}).on("keypress.browse","input",function(r){if(r.which==13){var s=e(this);var n=s.val();l.show(n)}});w.on("dblclick.browse","li",function(){var r=e(this);var s=l.join(c,r.text());if(r.hasClass("directory")){r.removeClass("selected");l.show(s)}else if(r.hasClass("file")){o.open(s)}}).on("click.browse","li",function(r){var s=e(this);if(!r.ctrlKey){s.siblings().removeClass("selected")}s.toggleClass("selected");var n=l.join(c,s.text());if(s.hasClass("selected")){if(!r.ctrlKey){t[o.name]=[]}t[o.name].push(n)}else if(r.ctrlKey){t[o.name]=t[o.name].filter(a(n))}else{t[o.name]=[]}});l.on("click.browse",function(r){e("."+i).removeClass("selected");e(this).addClass("selected");var s=e(r.target);if(!r.ctrlKey&&!s.is(".content li")&&!s.closest(".toolbar").length){w.find("li").removeClass("selected");t[o.name]=[]}});function m(e){if(l.hasClass("selected")){if(e.ctrlKey){if(e.which==67){l.copy();console.log(t[o.name].slice())}else if(e.which==88){l.cut()}else if(e.which==86){l.paste(n)}}else if(e.which==8){l.back()}else{var r=w.find(".selected");if(e.which==13&&r.length){r.dblclick()}else{if(e.which>=37&&e.which<=40){var s;var a=w.find("li");if(!r.length){r=w.find("li:eq(0)");s=0}else{r.removeClass("selected");var i=w.prop("clientWidth");var f=a.length;var d=w.find("li:eq(0)").outerWidth(true);var h=Math.floor(i/d);s=r.index();if(e.which==37){s--}else if(e.which==38){s=s-h}else if(e.which==39){s++}else if(e.which==40){s=s+h}if(s<0){s=0}else if(s>f-1){s=f-1}}if(e.which>=37&&e.which<=40){var u=a.eq(s).addClass("selected");var p=l.join(c,u.text());if(u.length){t[o.name]=[p]}else{t[o.name]=[]}}}}}}}function b(r){if(!e(r.target).closest("."+i).length){e(".browser-widget").removeClass("selected")}}e(document).on("click",b).on("keydown",m);e.extend(l,{path:function(){return c},name:function(){return o.name},current:function(){return current},back:function(){f.pop();l.show(f[f.length-1],{push:false});return l},destroy:function(){l.off(".browse");e(document).off("click",b).off("keydown",m);u.remove();w.remove()},_rename:function(e,r){o.rename(e,r)},_copy:function(e,r){o.copy(e,r)},copy:function(){s={path:c,contents:t[o.name],source:l};n=false},cut:function(){l.copy();n=true},paste:function(e){function r(e,r){s.contents.forEach(function(s){var n=e.split(s).pop();var t=e.join(c,n);if(s!=t){e[r](s,t)}})}if(s&&s.contents&&s.contents.length){if(l.name()!==s.source.name()){throw new Error("You can't paste across different filesystems")}else{if(e){r(l,"_rename")}else{r(l,"_copy")}l.refresh();if(l!==s.source){s.source.refresh()}}}},up:function(){var e=l.split(c);e.pop();l.show(l.join.apply(l,e));return l},refresh:function(){w.addClass("hidden");var r=e.Deferred();var s=e.Deferred();if(o.refresh_timer){setTimeout(r.resolve.bind(r),o.refresh_timer)}else{r.resolve()}l.show(c,{force:true,push:false,callback:function(){s.resolve()}});e.when(r,s).then(function(){w.removeClass("hidden")})},show:function(r,s){var n={callback:e.noop,push:true,force:false};s=e.extend({},n,s);if(c!=r||s.force){l.addClass("hidden");if(s.push){f.push(r)}h.find(".up").toggleClass("disabled",r==o.root);h.find(".back").toggleClass("disabled",f.length==1);c=r;o.dir(c,function(n){if(!n){o.error("Invalid directory");l.removeClass("hidden")}else{d=n;l.addClass("hidden");w.empty();d.dirs.forEach(function(s){var n=o.item_class(r,s);var t=e('<li class="directory">'+s+"</li>").appendTo(w);if(n){t.addClass(n)}});d.files.forEach(function(s){var n=e('<li class="file">'+s+"</li>").appendTo(w);if(s.match(".")){n.addClass(s.split(".").pop())}var t=o.item_class(r,s);if(t){n.addClass(t)}});l.removeClass("hidden");p.val(r);o.change.call(l);s.callback()}})}return l},join:function(){var r=[].slice.call(arguments);var s=r.map(function(r){var s=new RegExp(e.browse.escape_regex(o.separator)+"$","");return r.replace(s,"")}).filter(Boolean).join(o.separator);var n=new RegExp("^"+e.browse.escape_regex(o.root));return n.test(s)?s:o.root+s},split:function(r){var s=new RegExp("^"+e.browse.escape_regex(o.root));var n=new RegExp(e.browse.escape_regex(o.separator)+"$");r=r.replace(s,"").replace(n,"");if(r){return r.split(o.separator)}else{return[]}},walk:function(e,r){var s=this.split(e);var n;while(s.length){n=r(s.shift(),!s.length)}return n}});setTimeout(function(){var e=o.start_directory||o.root;l.show(e,{callback:o.init.bind(l)})},0);l.data("browse",l);return l}}})(jQuery);