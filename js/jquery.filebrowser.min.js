/**@license
 *
 * jQuery Browse - directory browser jQuery plugin 0.1.0
 *
 * Copyright (c) 2016 Jakub Jankiewicz <http://jcubic.pl>
 * Released under the MIT license
 *
 * Date: Thu, 08 Dec 2016 19:58:27 +0000
 */
(function(e,r){e.browse={defaults:{dir:function(){return{files:[],dirs:[]}},root:"/",separator:"/",labels:true,change:e.noop,init:e.noop,item_class:e.noop,open:e.noop,error:e.noop,refresh_timer:200},strings:{toolbar:{back:"back",up:"up",refresh:"refresh"}},escape_regex:function(e){if(typeof e=="string"){var r=/([-\\\^$\[\]()+{}?*.|])/g;return e.replace(r,"\\$1")}}};e.fn.browse=function(r){var s=e.extend({},e.browse.defaults,r);if(this.data("browse")){return this.data("browse")}else if(this.length>1){return this.each(function(){e.fn.browse.call(e(this),s)})}else{var a=this;a.addClass("browse hidden");var o;var t=[];var n;var i=e('<ul class="toolbar"></ul>').appendTo(a);if(s.labels){i.addClass("labels")}var l=e('<div class="adress-bar"></div>').appendTo(i);e("<button>Home</button>").addClass("home").appendTo(l);var c=e("<input />").appendTo(l);var d=e.browse.strings.toolbar;Object.keys(d).forEach(function(r){e("<li/>").text(d[r]).addClass(r).appendTo(i)});i.on("click.browse","li",function(){var r=e(this);if(!r.hasClass("disabled")){var s=r.text();a[s]()}}).on("click",".home",function(){if(o!=s.root){a.show(s.root)}}).on("keypress.browse","input",function(r){if(r.which==13){var o=e(this);var t=o.val();var n=new RegExp(e.browse.escape_regex(s.separator)+"$");if(!n.test(t)){t+=s.separator;o.val(t)}a.show(t)}});var f=e("<ul/>").appendTo(a);f.on("dblclick.browse","li",function(){var r=e(this);var t=a.join(o,r.text());if(r.hasClass("directory")){a.show(t)}else if(r.hasClass("file")){s.open(t)}});e.extend(a,{path:function(){return o},current:function(){return current},back:function(){t.pop();a.show(t[t.length-1],{push:false});return a},up:function(){var e=a.split(o);e.pop();a.show(a.join.apply(a,e));return a},refresh:function(){f.addClass("hidden");var r=e.Deferred();var t=e.Deferred();if(s.refresh_timer){setTimeout(r.resolve.bind(r),s.refresh_timer)}else{r.resolve()}a.show(o,{force:true,push:false,callback:function(){t.resolve()}});e.when(r,t).then(function(){f.removeClass("hidden")})},show:function(r,l){var d={callback:e.noop,push:true,force:false};l=e.extend({},d,l);if(o!=r||l.force){a.addClass("hidden");if(l.push){t.push(r)}i.find(".up").toggleClass("disabled",r==s.root);i.find(".back").toggleClass("disabled",t.length==1);o=r;s.dir(o,function(o){if(!o){s.error("Invalid directory");a.removeClass("hidden")}else{n=o;a.addClass("hidden");f.empty();n.dirs.forEach(function(a){var o=s.item_class(r,a);var t=e('<li class="directory">'+a+"</li>").appendTo(f);if(o){t.addClass(o)}});n.files.forEach(function(a){var o=e('<li class="file">'+a+"</li>").appendTo(f);if(a.match(".")){o.addClass(a.split(".").pop())}var t=s.item_class(r,a);if(t){o.addClass(t)}});a.removeClass("hidden");c.val(r);s.change.call(a);l.callback()}})}return a},join:function(){var r=[].slice.call(arguments);var a=r.map(function(r){var a=new RegExp(e.browse.escape_regex(s.separator)+"$","");return r.replace(a,"")}).filter(Boolean).join(s.separator)+s.separator;var o=new RegExp("^"+e.browse.escape_regex(s.root));return o.test(a)?a:s.root+a},split:function(r){var a=new RegExp("^"+e.browse.escape_regex(s.root));r=r.replace(a,"");if(r){return r.split(s.separator).slice(0,-1)}else{return[]}},walk:function(e,r){var s=this.split(e);var a;while(s.length){a=r(s.shift(),e)}return a}});setTimeout(function(){var e=s.start_directory||s.root;a.show(e,{callback:s.init.bind(a)})},0);a.data("browse",a);return a}}})(jQuery);