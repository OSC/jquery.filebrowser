/**@license
 *
 * jQuery File Browser - directory browser jQuery plugin version 0.8.0
 *
 * Copyright (c) 2016-2017 Jakub Jankiewicz <http://jcubic.pl/me>
 * Released under the MIT license
 *
 * Date: Sun, 03 Sep 2017 16:10:22 +0000
 */
(function(e,t){"use strict";function n(e,t,n){this.browser=e;this.upload=t;this.error=n}n.prototype.process=function t(n,r){var a=e.Deferred();var i=this;if(n.originalEvent){n=n.originalEvent}var s;if(n.dataTransfer.items){s=[].slice.call(n.dataTransfer.items)}var o=n.dataTransfer.files||n.target.files;if(o){o=[].slice.call(o)}if(s&&s.length){if(s[0].webkitGetAsEntry){var l=[];s.forEach(function(e){var t=e.webkitGetAsEntry();if(t){l.push(t)}});(function e(){var t=l.shift();if(t){i.upload_tree(t,r).then(e)}else{a.resolve()}})()}}else if(o&&o.length){(function e(){var t=o.shift();if(t){i.upload(t,r).then(e)}else{a.resolve()}})()}else if(n.dataTransfer.getFilesAndDirectories){n.dataTransfer.getFilesAndDirectories().then(function(e){(function t(){var n=e.shift();if(n){i.upload_tree(n,r).then(t)}else{a.resolve()}})()})}return a.promise()};n.prototype.upload_tree=function t(n,r){var a=e.Deferred();var i=this;function s(e,t){e=e.slice();(function n(){var r=e.shift();if(r){t(r).then(n).fail(function(){a.reject()})}else{a.resolve()}})()}function o(e){s(e,function(e){return i.upload_tree(e,i.browser.join(r,n.name))})}function l(e){i.upload(e,r).then(function(){a.resolve()}).fail(function(){a.reject()})}if(typeof Directory!="undefined"&&n instanceof Directory){n.getFilesAndDirectories().then(function(e){o(e)})}else if(typeof File!="undefined"&&n instanceof File){l(n)}else if(n.isFile){n.file(l)}else if(n.isDirectory){var f=n.createReader();f.readEntries(function(e){o(e)})}return a.promise()};e.browse={defaults:{dir:function(){return e.when({files:[],dirs:[]})},root:"/",separator:"/",labels:true,change:e.noop,init:e.noop,item_class:e.noop,rename_delay:300,dbclick_delay:2e3,open:e.noop,rename:e.noop,create:e.noop,remove:e.noop,copy:e.noop,upload:e.noop,name:"default",error:e.noop,refresh_timer:100},strings:{toolbar:{back:"back",up:"up",refresh:"refresh"}},escape_regex:function(e){if(typeof e=="string"){var t=/([-\\\^$\[\]()+{}?*.|])/g;return e.replace(t,"\\$1")}}};var r;var a;var i={};var s;function o(e){return function(t){return e==t}}function l(t,n){var r=e(n);return r.parents().add("html,body").map(function(){return e(this)[t]()}).get().reduce(function(e,t){return e+t})}function f(t,n){return t===n||n.match(new RegExp("^"+e.browse.escape_regex(t)))}e.fn.browse=function(t){var c=e.extend({},e.browse.defaults,t);function u(t){if(G){var n=B.offset();O=t.clientX-n.left;W=t.clientY-n.top;X.show();v();N=true;var r=$.find("li");if(!t.ctrlKey){r.removeClass("selected");i[c.name]=[]}var a=X[0].getBoundingClientRect();var s=r.filter(function(){var e=this.getBoundingClientRect();return e.top+e.height>a.top&&e.left+e.width>a.left&&e.bottom-e.height<a.bottom&&e.right-e.width<a.right});s.addClass("selected").each(function(){i[c.name].push(C.join(k,e(this).text()))})}}function d(t){if(!e(t.target).closest(".menu").length){b()}}function h(e){G=false;X.hide();C.removeClass("no-select")}function v(e){var t=l("scrollTop",$);var n=Math.max(Math.min(q,O),0);var r=Math.max(Math.min(H,W),-t);var a=Math.max(q,O);var i=Math.max(H,W);var s=$.prop("clientWidth");var o=$.height()+$.scrollTop()-2;if(a>s){a=s}if(i>o){i=o}X.css({left:n,top:r+t,width:a-n,height:i-r})}function p(t){if(C.hasClass("selected")&&!e(t.target).is("textarea")){var n;var r=$.find(".active");if(t.ctrlKey){if(t.which==67){C.copy()}else if(t.which==88){C.cut()}else if(t.which==86){C.paste(a)}}if(t.which==32){var t=jQuery.Event("click");t.ctrlKey=true;t.target=r[0];r.trigger(t);return false}else if(t.which==8){C.back()}else{if(t.which==13&&r.length){E=(new Date).getTime();r.dblclick()}else{if(t.which>=37&&t.which<=40){if(!t.ctrlKey){$.find("li").removeClass("selected")}if(!r.length){r=$.find("li:eq(0)").addClass("active")}else{var i=$.find("li");var s=$.prop("clientWidth");var o=i.length;var l=$.find("li:eq(0)").outerWidth(true);var f=Math.floor(s/l);n=r.index();if(t.which==37){n--}else if(t.which==38){n=n-f}else if(t.which==39){n++}else if(t.which==40){n=n+f}if(n<0){n=0}else if(n>o-1){n=o-1}i.eq(n).addClass("active").siblings().removeClass("active")}}}}}}function m(t){if(!e(t.target).closest("."+x).length){e(".browser-widget").removeClass("selected")}var n=e(t.target);if(!n.closest(".menu").length||n.closest(".menu li").length){b()}}function w(){e("."+x).each(function(){var t=e(this).browse();if(t.path()==k&&t.name()==c.name){t.refresh()}})}function g(t){var n=e(this);var r=n.parent();var a=n.val();if(r.hasClass("rename")){n.remove();r.removeClass("rename");var i=r.find("span").text();if(a!=i){e.when(c.rename(C.join(k,i),C.join(k,a))).then(w)}}else if(r.hasClass("new")){if(t){r.remove()}else{var s;if(r.hasClass("directory")){s="directory"}else{s="file"}e.when(c.create(C.join(k,a),s)).then(w)}}}function b(){e(".browser-widget .menu").menu("destroy").remove();I=null}function y(){var e;if($.prop){e=$.prop("scrollHeight")}else{e=$.attr("scrollHeight")}$.scrollTop(e)}if(this.data("browse")){return this.data("browse")}else if(this.length>1){return this.each(function(){e.fn.browse.call(e(this),c)})}else{var x="browser-widget";i[c.name]=i[c.name]||[];var C=this;C.addClass(x+" hidden");var T=new n(C,c.upload,c.error);var k;var _=[];var j;var E;var D=false;var K=0;var R=e('<div class="toolbar"/>').appendTo(C);var F=e('<div class="adress-bar"></div>').appendTo(R);e("<button>Home</button>").addClass("home").appendTo(F);var M=e("<ul></ul>").appendTo(R);if(c.labels){M.addClass("labels")}var A=e("<input />").appendTo(F);var Y=e.browse.strings.toolbar;Object.keys(Y).forEach(function(t){e("<li/>").text(Y[t]).addClass(t).appendTo(M)});var $=e("<ul/>").wrap("<div/>").parent().addClass("content").appendTo(C);var B=$.find("ul");var q=0,H=0,O=0,W=0;var X=e("<div/>").addClass("selection").hide().appendTo($);var G=false;var N=false;R.on("click.browse","li",function(){var t=e(this);if(!t.hasClass("disabled")){var n=t.text();C[n]()}}).on("click",".home",function(){if(k!=c.root){C.show(c.root)}}).on("keydown.browse","input",function(t){if(t.which==13){var n=e(this);var r=n.val();C.show(r);return false}});function Q(t){if(!t.is(".new, .rename")){var n=t.find("span").text();e("<textarea>"+n+"</textarea>").appendTo(t).focus().select();t.addClass("rename")}else{t.find("textarea").focus().select()}}var I;$.on("dblclick.browse","li",function(t){var n=e(this);var r=(new Date).getTime()-E;if(r<c.rename_delay&&r<c.dbclick_delay){var a=n.find("span").text();var i=C.join(k,a);if(n.hasClass("directory")){n.removeClass("selected");C.show(i)}else if(n.hasClass("file")){c.open(i)}}}).on("click.browse","ul:not(.menu) > li",function(t){if(!G){var n=e(t.target);var r=e(this);var a=r.find("span").text();var s=C.join(k,a);if(n.is("span")){if(K++%2===0){E=(new Date).getTime()}else{var l=(new Date).getTime()-E;if(l>c.rename_delay&&l<c.dbclick_delay){Q(r);return false}}}else{E=(new Date).getTime()}if(!t.ctrlKey){r.siblings().removeClass("selected")}if(!n.is("textarea")){$.find(".active").removeClass("active");r.toggleClass("selected").addClass("active");if(r.hasClass("selected")){if(!t.ctrlKey){i[c.name]=[]}i[c.name].push(s)}else if(t.ctrlKey){i[c.name]=i[c.name].filter(o(s))}else{i[c.name]=[]}}}}).on("keydown","textarea",function(e){if(e.which==13||e.which==27){g.call(this,e.which==27)}if([13,27].indexOf(e.which)!=-1){return false}}).on("contextmenu",function(t){if(c.contextmenu&&!t.ctrlKey){b();I=e(t.target);if(!I.is("textarea")){var n;var r=I.closest("li");if(r.length){r.addClass("active");n=e(['<ul class="menu">','  <li class="rename"><div>rename</div></li>','  <li class="delete"><div>delete</div></li>',"</ul>"].join("")).appendTo($)}else{$.find("li.active").removeClass("active");n=e(['<ul class="menu">','  <li class="new"><div>New</div>',"    <ul>",'      <li class="directory"><div>Directory</div></li>','      <li class="file"><div>File</div></li>',"    </ul>","  </li>","</ul>"].join("")).appendTo($)}n.menu();var a=$.offset();n.css({left:t.pageX-a.left,top:t.pageY-a.top});return false}}}).on("click",".menu li",function(){var t=e(this);if(I){var n=I.closest("ul:not(.menu) li");Object.keys(z).forEach(function(e){if(t.is(e)){z[e](n)}});if(!t.find("> ul").length){b()}return false}});var z={".rename":Q,".delete":function(t){e.when.apply(e,$.find("li.selected").map(function(){var t=e(this).find("span").text();return c.remove(C.join(k,t))})).then(w)},".new .directory":function(e){J("directory","Directory")},".new .file":function(e){J("file","File")}};function J(t,n){var r=e(['<li class="new '+t+'" draggable="true">',"  <span></span>","  <textarea/>","</li>"].join("")).appendTo(B);y();r.find("textarea").val("New "+n).focus().select()}C.on("click.browse",function(t){e("."+x).removeClass("selected");C.addClass("selected");var n=e(t.target);if(!N){if(!t.ctrlKey&&!n.is(".content li")&&!n.closest(".toolbar").length){$.find("li").removeClass("selected");i[c.name]=[]}}if(!n.is("textarea")){$.find("li.rename,li.new").find("textarea").each(g)}});C.on("dragover.browse",".content",function(e){if(e.originalEvent){e=e.originalEvent}e.dataTransfer.dropEffect="move";return false}).on("dragstart",".content li",function(t){t.originalEvent.dataTransfer.setData("text","anything");var n=e(this);var r=n.text();s={name:r,node:n,path:k,context:C};s.selection=n.hasClass("selected")});function L(e){if(e.originalEvent){e=e.originalEvent}if(e.dataTransfer.items&&e.dataTransfer.items.length){return!![].filter.call(e.dataTransfer.items,function(e){return e.kind=="file"}).length}else{return e.dataTransfer.files&&e.dataTransfer.files.length}}$.on("drop.browse",function(t){var n=e(t.target);var r;if(n.is(".directory")){r=C.join(k,n.text())}else{r=k}if(L(t)){T.process(t,r).then(function(){if(!n.is(".directory")){w()}})}else{if(C.name()!==s.context.name()){var a="You can't drag across different filesystems";throw new Error(a)}var o;if(s.selection){o=e.when.appy(e,i[c.name].map(function(e){var t=C.join(r,C.split(e).pop());if(!f(e,t)){return C._rename(e,t)}}))}else{var l=C.join(s.path,s.name);var u=C.join(r,s.name);o=C._rename(l,u)}o.then(function(){s.context.refresh();w()})}return false}).on("mousedown.browse",function(t){var n=e(t.target);if(!n.is("li")&&!n.is("span")&&!n.is("textarea")){G=true;N=false;C.addClass("no-select");var r=B.offset();q=t.clientX-r.left;H=t.clientY-r.top}});e(document).on("click",m).on("keydown",p).on("mousedown",d).on("mousemove",u).on("mouseup",h);e.extend(C,{path:function(){return k},name:function(){return c.name},current:function(){return current},back:function(){if(_.length>1){_.pop();C.show(_[_.length-1],{push:false})}return C},destroy:function(){C.off(".browse");e(document).off("click",m).off("keydown",p).off("mousedown",d).off("mousemove",u).off("mouseup",h);F.remove();$.remove()},_rename:function(t,n){if(!f(t,n)){return c.rename(t,n)}else{return e.when()}},_copy:function(t,n){if(!f(t,n)){return c.copy(t,n)}else{return e.when()}},copy:function(){r={path:k,contents:i[c.name],source:C};a=false},cut:function(){C.copy();a=true},paste:function(t){function n(t,n){return e.when.apply(e,r.contents.map(function(r){var a=t.split(r).pop();var i=t.join(k,a);if(!f(r,i)){return t[n](r,i)}else{return e.when()}}))}if(r&&r.contents&&r.contents.length){if(C.name()!==r.source.name()){throw new Error("You can't paste across different filesystems")}else{var a;if(t){a=n(C,"_rename")}else{a=n(C,"_copy")}a.then(function(){r.source.refresh();w()})}}},up:function(){var e=C.split(k);e.pop();C.show(C.join.apply(C,e));return C},refresh:function(){$.addClass("hidden");var t=e.Deferred();var n=e.Deferred();if(c.refresh_timer){setTimeout(t.resolve.bind(t),c.refresh_timer)}else{t.resolve()}C.show(k,{force:true,push:false,callback:function(){n.resolve()}});e.when(t,n).then(function(){$.removeClass("hidden")})},show:function(t,n){var r={callback:e.noop,push:true,force:false};n=e.extend({},r,n);if(k!=t||n.force){C.addClass("hidden");if(n.push){_.push(t)}R.find(".up").toggleClass("disabled",t==c.root);R.find(".back").toggleClass("disabled",_.length==1);k=t;var a=c.dir(k,s);if(a&&a.then){a.then(s).catch(function(){s()})}var i=false;function s(r){if(i){return}i=true;if(!r){c.error("Invalid directory");C.removeClass("hidden")}else{j=r;B.empty();j.dirs.forEach(function(n){var r=c.item_class(t,n);var a=e('<li class="directory"><span>'+n+"</span></li>").appendTo(B).attr("draggable",true);if(r){a.addClass(r)}});j.files.forEach(function(n){var r=e('<li class="file"><span>'+n+"</span></li>").appendTo(B).attr("draggable",true);if(n.match(".")){r.addClass(n.split(".").pop())}var a=c.item_class(t,n);if(a){r.addClass(a)}});C.removeClass("hidden");var a=new RegExp(e.browse.escape_regex(c.separator)+"$");if(!t.match(a)&&t!=c.root){t+=c.separator}A.val(t);c.change.call(C);n.callback()}}}return C},join:function(){var t=[].slice.call(arguments);var n=t.map(function(t){var n=new RegExp(e.browse.escape_regex(c.separator)+"$","");return t.replace(n,"")}).filter(Boolean).join(c.separator);var r=new RegExp("^"+e.browse.escape_regex(c.root));return r.test(n)?n:c.root+n},split:function(t){var n=new RegExp("^"+e.browse.escape_regex(c.root));var r=new RegExp(e.browse.escape_regex(c.separator)+"$");t=t.replace(n,"").replace(r,"");if(t){return t.split(c.separator).filter(Boolean)}else{return[]}},walk:function(e,t){var n=this.split(e);var r;while(n.length){r=t(n.shift(),!n.length)}return r}});setTimeout(function(){var e=c.start_directory||c.root;C.show(e,{callback:c.init.bind(C)})},0);C.data("browse",C);return C}}})(jQuery);