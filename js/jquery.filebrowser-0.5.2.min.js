/**@license
 *
 * jQuery File Browser - directory browser jQuery plugin version 0.5.2
 *
 * Copyright (c) 2016 Jakub Jankiewicz <http://jcubic.pl>
 * Released under the MIT license
 *
 * Date: Sun, 18 Dec 2016 19:12:07 +0000
 */
(function(e,t){"use strict";e.browse={defaults:{dir:function(){return{files:[],dirs:[]}},root:"/",separator:"/",labels:true,change:e.noop,init:e.noop,item_class:e.noop,open:e.noop,rename:e.noop,copy:e.noop,name:"default",error:e.noop,refresh_timer:100},strings:{toolbar:{back:"back",up:"up",refresh:"refresh"}},escape_regex:function(e){if(typeof e=="string"){var t=/([-\\\^$\[\]()+{}?*.|])/g;return e.replace(t,"\\$1")}}};var r;var n;var a={};var s;function o(e){return function(t){return e==t}}function i(t,r){return t===r||r.match(new RegExp("^"+e.browse.escape_regex(t)))}function l(t,r){var n=e(r);return n.parents().add("html,body").map(function(){return e(this)[t]()}).get().reduce(function(e,t){return e+t})}e.fn.browse=function(t){var c=e.extend({},e.browse.defaults,t);function f(t){if(Y){var r=j.offset();M=t.clientX-r.left;R=t.clientY-r.top;K.show();h();$=true;var n=_.find("li");if(!t.ctrlKey){n.removeClass("selected");a[c.name]=[]}var s=K[0].getBoundingClientRect();var o=n.filter(function(){var e=this.getBoundingClientRect();return e.top+e.height>s.top&&e.left+e.width>s.left&&e.bottom-e.height<s.bottom&&e.right-e.width<s.right});o.addClass("selected").each(function(){a[c.name].push(m.join(w,e(this).text()))})}}function d(e){Y=false;K.hide();m.removeClass("no-select")}function h(e){var t=l("scrollTop",_);var r=Math.max(Math.min(T,M),0);var n=Math.max(Math.min(E,R),-t);var a=Math.max(T,M);var s=Math.max(E,R);var o=_.prop("clientWidth");var i=_.height()+_.scrollTop()-2;if(a>o){a=o}if(s>i){s=i}K.css({left:r,top:n+t,width:a-r,height:s-n})}function u(e){if(m.hasClass("selected")){if(e.ctrlKey){if(e.which==67){m.copy()}else if(e.which==88){m.cut()}else if(e.which==86){m.paste(n)}}else if(e.which==8){m.back()}else{var t=_.find(".selected");if(e.which==13&&t.length){t.dblclick()}else{if(e.which>=37&&e.which<=40){var r;var s=_.find("li");if(!t.length){t=_.find("li:eq(0)");r=0}else{t.removeClass("selected");var o=_.prop("clientWidth");var i=s.length;var l=_.find("li:eq(0)").outerWidth(true);var f=Math.floor(o/l);r=t.index();if(e.which==37){r--}else if(e.which==38){r=r-f}else if(e.which==39){r++}else if(e.which==40){r=r+f}if(r<0){r=0}else if(r>i-1){r=i-1}}if(e.which>=37&&e.which<=40){var d=s.eq(r).addClass("selected");var h=m.join(w,d.text());if(d.length){a[c.name]=[h]}else{a[c.name]=[]}}}}}}}function p(t){if(!e(t.target).closest("."+v).length){e(".browser-widget").removeClass("selected")}}if(this.data("browse")){return this.data("browse")}else if(this.length>1){return this.each(function(){e.fn.browse.call(e(this),c)})}else{var v="browser-widget";a[c.name]=a[c.name]||[];var m=this;m.addClass(v+" hidden");var w;var g=[];var b;var C=e('<ul class="toolbar"></ul>').appendTo(m);if(c.labels){C.addClass("labels")}var x=e('<div class="adress-bar"></div>').appendTo(C);e("<button>Home</button>").addClass("home").appendTo(x);var y=e("<input />").appendTo(x);var k=e.browse.strings.toolbar;Object.keys(k).forEach(function(t){e("<li/>").text(k[t]).addClass(t).appendTo(C)});var _=e("<ul/>").wrap("<div/>").parent().addClass("content").appendTo(m);var j=_.find("ul");var T=0,E=0,M=0,R=0;var K=e("<div/>").addClass("selection").hide().appendTo(_);var Y=false;var $=false;C.on("click.browse","li",function(){var t=e(this);if(!t.hasClass("disabled")){var r=t.text();m[r]()}}).on("click",".home",function(){if(w!=c.root){m.show(c.root)}}).on("keypress.browse","input",function(t){if(t.which==13){var r=e(this);var n=r.val();m.show(n)}});_.on("dblclick.browse","li",function(){var t=e(this);var r=m.join(w,t.text());if(t.hasClass("directory")){t.removeClass("selected");m.show(r)}else if(t.hasClass("file")){c.open(r)}}).on("click.browse","li",function(t){var r=e(this);if(!t.ctrlKey){r.siblings().removeClass("selected")}r.toggleClass("selected");var n=m.join(w,r.text());if(r.hasClass("selected")){if(!t.ctrlKey){a[c.name]=[]}a[c.name].push(n)}else if(t.ctrlKey){a[c.name]=a[c.name].filter(o(n))}else{a[c.name]=[]}});m.on("click.browse",function(t){e(this).addClass("selected");if(!$){e("."+v).removeClass("selected");var r=e(t.target);if(!t.ctrlKey&&!r.is(".content li")&&!r.closest(".toolbar").length){_.find("li").removeClass("selected");a[c.name]=[]}}});m.on("dragover.browse",".content",function(){return false}).on("dragstart",".content li",function(){var t=e(this);var r=t.text();s={name:r,path:w,context:m};if(t.hasClass("selected")){s.selection=true}});_.on("drop.browse",function(t){var r=e(t.target);var n;if(r.is(".directory")){n=m.join(w,r.text(),s.name)}else{n=m.join(w,s.name)}if(m.name()!==s.context.name()){throw new Error("You can't drag across different filesystems")}if(s.selection){a[c.name].forEach(function(e){if(!i(e,n)){m._rename(e,n)}});m.refresh();if(m!==s.context){s.context.refresh()}}else{var o=m.join(s.path,s.name);if(!i(o,n)){m._rename(o,n);m.refresh();if(m!==s.context){s.context.refresh()}}}return false});j.on("mousedown.browse",function(t){if(!e(t.target).is("li")){Y=true;$=false;m.addClass("no-select");var r=j.offset();T=t.clientX-r.left;E=t.clientY-r.top}});e(document).on("click",p).on("keydown",u).on("mousemove",f).on("mouseup",d);e.extend(m,{path:function(){return w},name:function(){return c.name},current:function(){return current},back:function(){g.pop();m.show(g[g.length-1],{push:false});return m},destroy:function(){m.off(".browse");e(document).off("click",p).off("keydown",u);x.remove();_.remove()},_rename:function(e,t){if(!i(e,t)){c.rename(e,t)}},_copy:function(e,t){c.copy(e,t)},copy:function(){r={path:w,contents:a[c.name],source:m};n=false},cut:function(){m.copy();n=true},paste:function(e){function t(e,t){r.contents.forEach(function(r){var n=e.split(r).pop();var a=e.join(w,n);if(!i(r,a)){e[t](r,a)}})}if(r&&r.contents&&r.contents.length){if(m.name()!==r.source.name()){throw new Error("You can't paste across different filesystems")}else{if(e){t(m,"_rename")}else{t(m,"_copy")}m.refresh();if(m!==r.source){r.source.refresh()}}}},up:function(){var e=m.split(w);e.pop();m.show(m.join.apply(m,e));return m},refresh:function(){_.addClass("hidden");var t=e.Deferred();var r=e.Deferred();if(c.refresh_timer){setTimeout(t.resolve.bind(t),c.refresh_timer)}else{t.resolve()}m.show(w,{force:true,push:false,callback:function(){r.resolve()}});e.when(t,r).then(function(){_.removeClass("hidden")})},show:function(t,r){var n={callback:e.noop,push:true,force:false};r=e.extend({},n,r);if(w!=t||r.force){m.addClass("hidden");if(r.push){g.push(t)}C.find(".up").toggleClass("disabled",t==c.root);C.find(".back").toggleClass("disabled",g.length==1);w=t;c.dir(w,function(n){if(!n){c.error("Invalid directory");m.removeClass("hidden")}else{b=n;m.addClass("hidden");j.empty();b.dirs.forEach(function(r){var n=c.item_class(t,r);var a=e('<li class="directory">'+r+"</li>").appendTo(j).attr("draggable",true);if(n){a.addClass(n)}});b.files.forEach(function(r){var n=e('<li class="file">'+r+"</li>").appendTo(j).attr("draggable",true);if(r.match(".")){n.addClass(r.split(".").pop())}var a=c.item_class(t,r);if(a){n.addClass(a)}});m.removeClass("hidden");y.val(t);c.change.call(m);r.callback()}})}return m},join:function(){var t=[].slice.call(arguments);var r=t.map(function(t){var r=new RegExp(e.browse.escape_regex(c.separator)+"$","");return t.replace(r,"")}).filter(Boolean).join(c.separator);var n=new RegExp("^"+e.browse.escape_regex(c.root));return n.test(r)?r:c.root+r},split:function(t){var r=new RegExp("^"+e.browse.escape_regex(c.root));var n=new RegExp(e.browse.escape_regex(c.separator)+"$");t=t.replace(r,"").replace(n,"");if(t){return t.split(c.separator)}else{return[]}},walk:function(e,t){var r=this.split(e);var n;while(r.length){n=t(r.shift(),!r.length)}return n}});setTimeout(function(){var e=c.start_directory||c.root;m.show(e,{callback:c.init.bind(m)})},0);m.data("browse",m);return m}}})(jQuery);