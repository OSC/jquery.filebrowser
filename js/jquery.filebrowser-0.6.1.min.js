/**@license
 *
 * jQuery File Browser - directory browser jQuery plugin version 0.6.1
 *
 * Copyright (c) 2016 Jakub Jankiewicz <http://jcubic.pl>
 * Released under the MIT license
 *
 * Date: Thu, 22 Dec 2016 10:30:46 +0000
 */
(function(e,t){"use strict";e.browse={defaults:{dir:function(){return{files:[],dirs:[]}},root:"/",separator:"/",labels:true,change:e.noop,init:e.noop,item_class:e.noop,rename_delay:300,dbclick_delay:2e3,open:e.noop,rename:e.noop,copy:e.noop,name:"default",error:e.noop,refresh_timer:100},strings:{toolbar:{back:"back",up:"up",refresh:"refresh"}},escape_regex:function(e){if(typeof e=="string"){var t=/([-\\\^$\[\]()+{}?*.|])/g;return e.replace(t,"\\$1")}}};var r;var a;var n={};var s;function i(e){return function(t){return e==t}}function o(t,r){return t===r||r.match(new RegExp("^"+e.browse.escape_regex(t)))}function l(t,r){var a=e(r);return a.parents().add("html,body").map(function(){return e(this)[t]()}).get().reduce(function(e,t){return e+t})}e.fn.browse=function(t){var c=e.extend({},e.browse.defaults,t);function f(t){if(W){var r=R.offset();$=t.clientX-r.left;q=t.clientY-r.top;B.show();h();O=true;var a=M.find("li");if(!t.ctrlKey){a.removeClass("selected");n[c.name]=[]}var s=B[0].getBoundingClientRect();var i=a.filter(function(){var e=this.getBoundingClientRect();return e.top+e.height>s.top&&e.left+e.width>s.left&&e.bottom-e.height<s.bottom&&e.right-e.width<s.right});i.addClass("selected").each(function(){n[c.name].push(g.join(w,e(this).text()))})}}function d(e){W=O=false;B.hide();g.removeClass("no-select")}function h(e){var t=l("scrollTop",M);var r=Math.max(Math.min(D,$),0);var a=Math.max(Math.min(Y,q),-t);var n=Math.max(D,$);var s=Math.max(Y,q);var i=M.prop("clientWidth");var o=M.height()+M.scrollTop()-2;if(n>i){n=i}if(s>o){s=o}B.css({left:r,top:a+t,width:n-r,height:s-a})}function u(e){if(g.hasClass("selected")&&!y){var t;var r=M.find(".active");if(e.ctrlKey){if(e.which==67){g.copy()}else if(e.which==88){g.cut()}else if(e.which==86){g.paste(a)}}if(e.which==32){var e=jQuery.Event("click");e.ctrlKey=true;e.target=r[0];r.trigger(e);return false}else if(e.which==8){g.back()}else{if(e.which==13&&r.length){r.dblclick()}else{if(e.which>=37&&e.which<=40){if(!e.ctrlKey){M.find("li").removeClass("selected")}if(!r.length){r=M.find("li:eq(0)").addClass("active")}else{var n=M.find("li");var s=M.prop("clientWidth");var i=n.length;var o=M.find("li:eq(0)").outerWidth(true);var l=Math.floor(s/o);t=r.index();if(e.which==37){t--}else if(e.which==38){t=t-l}else if(e.which==39){t++}else if(e.which==40){t=t+l}if(t<0){t=0}else if(t>i-1){t=i-1}n.eq(t).addClass("active").siblings().removeClass("active")}}}}}}function v(t){if(!e(t.target).closest("."+m).length){e(".browser-widget").removeClass("selected")}}function p(){var t=e(this);var r=t.parent().find("span").text();var a=t.val();if(a!=r){console.log(g.join(w,r),g.join(w,a));g._rename(g.join(w,r),g.join(w,a));g.refresh()}}if(this.data("browse")){return this.data("browse")}else if(this.length>1){return this.each(function(){e.fn.browse.call(e(this),c)})}else{var m="browser-widget";n[c.name]=n[c.name]||[];var g=this;g.addClass(m+" hidden");var w;var b=[];var C;var x;var y=false;var k=0;var _=e('<div class="toolbar"/>').appendTo(g);var j=e('<div class="adress-bar"></div>').appendTo(_);e("<button>Home</button>").addClass("home").appendTo(j);var T=e("<ul></ul>").appendTo(_);if(c.labels){T.addClass("labels")}var E=e("<input />").appendTo(j);var K=e.browse.strings.toolbar;Object.keys(K).forEach(function(t){e("<li/>").text(K[t]).addClass(t).appendTo(T)});var M=e("<ul/>").wrap("<div/>").parent().addClass("content").appendTo(g);var R=M.find("ul");var D=0,Y=0,$=0,q=0;var B=e("<div/>").addClass("selection").hide().appendTo(M);var W=false;var O=false;_.on("click.browse","li",function(){var t=e(this);if(!t.hasClass("disabled")){var r=t.text();g[r]()}}).on("click",".home",function(){if(w!=c.root){g.show(c.root)}}).on("keypress.browse","input",function(t){if(t.which==13){var r=e(this);var a=r.val();g.show(a)}});M.on("dblclick.browse","li",function(t){var r=e(this);var a=r.find("span").text();var n=g.join(w,a);var s=(new Date).getTime()-x;if(s<c.rename_delay&&s<c.dbclick_delay){if(r.hasClass("directory")){r.removeClass("selected");g.show(n)}else if(r.hasClass("file")){c.open(n)}}}).on("click.browse","li",function(t){console.log(O);if(!O){var r=e(t.target);var a=e(this);var s=a.find("span").text();var o=g.join(w,s);if(r.is("span")){console.log("span");if(k++%2===0){x=(new Date).getTime()}else{console.log("db click");var l=(new Date).getTime()-x;if(l>c.rename_delay&&l<c.dbclick_delay){e("<textarea>"+s+"</textarea>").appendTo(a).focus().select();a.addClass("rename");y=true;return false}}}if(!t.ctrlKey){a.siblings().removeClass("selected")}if(!r.is("textarea")){M.find(".active").removeClass("active");a.toggleClass("selected").addClass("active");if(a.hasClass("selected")){if(!t.ctrlKey){n[c.name]=[]}n[c.name].push(o)}else if(t.ctrlKey){n[c.name]=n[c.name].filter(i(o))}else{n[c.name]=[]}}}}).on("keypress","textarea",function(t){if(t.which==13){p.call(this)}else if(t.which==27){var r=e(this);r.parent().removeClass("rename");r.remove()}if([13,27].indexOf(t.which)!=-1){y=false;return false}});g.on("click.browse",function(t){e("."+m).removeClass("selected");g.addClass("selected");var r=e(t.target);if(!O){if(!t.ctrlKey&&!r.is(".content li")&&!r.closest(".toolbar").length){M.find("li").removeClass("selected");n[c.name]=[]}}if(!r.is("textarea")){M.find("li.rename").removeClass("rename").find("textarea").each(p).remove();y=false}});g.on("dragover.browse",".content",function(){return false}).on("dragstart",".content li",function(){var t=e(this);var r=t.text();s={name:r,path:w,context:g};if(t.hasClass("selected")){s.selection=true}});M.on("drop.browse",function(t){var r=e(t.target);if(g.name()!==s.context.name()){throw new Error("You can't drag across different filesystems")}var a;if(r.is(".directory")){a=g.join(w,r.text())}else{a=w}if(s.selection){n[c.name].forEach(function(e){var t=g.join(a,g.split(e).pop());if(!o(e,t)){g._rename(e,t)}});g.refresh();if(g!==s.context){s.context.refresh()}}else{var i=g.join(w,s.name);var l=g.join(s.path,s.name);if(!o(l,i)){g._rename(l,i);g.refresh();if(g!==s.context){s.context.refresh()}}}return false}).on("mousedown.browse",function(t){var r=e(t.target);if(!r.is("li")&&!r.is("span")){W=true;O=false;g.addClass("no-select");var a=R.offset();D=t.clientX-a.left;Y=t.clientY-a.top}});e(document).on("click",v).on("keydown",u).on("mousemove",f).on("mouseup",d);e.extend(g,{path:function(){return w},name:function(){return c.name},current:function(){return current},back:function(){if(b.length>1){b.pop();g.show(b[b.length-1],{push:false})}return g},destroy:function(){g.off(".browse");e(document).off("click",v).off("keydown",u);j.remove();M.remove()},_rename:function(e,t){if(!o(e,t)){c.rename(e,t)}},_copy:function(e,t){c.copy(e,t)},copy:function(){r={path:w,contents:n[c.name],source:g};a=false},cut:function(){g.copy();a=true},paste:function(e){function t(e,t){r.contents.forEach(function(r){var a=e.split(r).pop();var n=e.join(w,a);if(!o(r,n)){e[t](r,n)}})}if(r&&r.contents&&r.contents.length){if(g.name()!==r.source.name()){throw new Error("You can't paste across different filesystems")}else{if(e){t(g,"_rename")}else{t(g,"_copy")}g.refresh();if(g!==r.source){r.source.refresh()}}}},up:function(){var e=g.split(w);e.pop();g.show(g.join.apply(g,e));return g},refresh:function(){M.addClass("hidden");var t=e.Deferred();var r=e.Deferred();if(c.refresh_timer){setTimeout(t.resolve.bind(t),c.refresh_timer)}else{t.resolve()}g.show(w,{force:true,push:false,callback:function(){r.resolve()}});e.when(t,r).then(function(){M.removeClass("hidden")})},show:function(t,r){var a={callback:e.noop,push:true,force:false};r=e.extend({},a,r);if(w!=t||r.force){g.addClass("hidden");if(r.push){b.push(t)}_.find(".up").toggleClass("disabled",t==c.root);_.find(".back").toggleClass("disabled",b.length==1);w=t;c.dir(w,function(a){if(!a){c.error("Invalid directory");g.removeClass("hidden")}else{C=a;g.addClass("hidden");R.empty();C.dirs.forEach(function(r){var a=c.item_class(t,r);var n=e('<li class="directory"><span>'+r+"</span></li>").appendTo(R).attr("draggable",true);if(a){n.addClass(a)}});C.files.forEach(function(r){var a=e('<li class="file"><span>'+r+"</span></li>").appendTo(R).attr("draggable",true);if(r.match(".")){a.addClass(r.split(".").pop())}var n=c.item_class(t,r);if(n){a.addClass(n)}});g.removeClass("hidden");E.val(t);c.change.call(g);r.callback()}})}return g},join:function(){var t=[].slice.call(arguments);var r=t.map(function(t){var r=new RegExp(e.browse.escape_regex(c.separator)+"$","");return t.replace(r,"")}).filter(Boolean).join(c.separator);var a=new RegExp("^"+e.browse.escape_regex(c.root));return a.test(r)?r:c.root+r},split:function(t){var r=new RegExp("^"+e.browse.escape_regex(c.root));var a=new RegExp(e.browse.escape_regex(c.separator)+"$");t=t.replace(r,"").replace(a,"");if(t){return t.split(c.separator)}else{return[]}},walk:function(e,t){var r=this.split(e);var a;while(r.length){a=t(r.shift(),!r.length)}return a}});setTimeout(function(){var e=c.start_directory||c.root;g.show(e,{callback:c.init.bind(g)})},0);g.data("browse",g);return g}}})(jQuery);